<html>
<head><title>Curso JSP (Java Server Pages)</title></head>
<body bgcolor=white>

<a href="../etiquetasjsp.html">Etiquetas JSP</a> |
<a href="etiquetaconparametros.html">Anterior</a> |
<a href="etiquetaconcuerpo.html">Siguiente</a>


<h2>Etiquetas con cuerpo</h2>
<ul>
        <li>La misma estructura que etiquetas de html del estilo de &lt;h1&gt;titulo&lt;/h1&gt;.</li>
        <li>Son etiquetas con etiqueta de apertura y de cierre con algo dentro, que llamamos cuerpo.</li>
        <li>Heredar de la clase BodyTagSupport (o implementar la interfaz BodyTag) y sobreescribir los métodos necesarios.</li>
</ul>


<h2>Ejemplo</h2>
<ul>
        <li>Vamos a hacer una etiqueta que nos diga el tamaño de la cadena que se le pasa en el cuerpo.</li>
        <li>El código sobreescribe el método doAfterBody() que se ejecuta despues de comprobar el contenido del cuerpo de la etiqueta:</li>
<blockquote><pre>
// LongitudTag.java
import java.io.*;
import javax.servlet.jsp.*;
import javax.servlet.jsp.tagext.*;

public class LongitudTag extends BodyTagSupport{
    public int doAfterBody() throws JspException {
        try {
            BodyContent bc = getBodyContent();
            String cuerpo = bc.getString();
            JspWriter out = bc.getEnclosingWriter();
            if (cuerpo != null){
                out.print("la longitud de " + cuerpo + "es: " + 
				              cuerpo.length());
            }
        } catch (IOException e){
            throw new JspException("Error: IOEXception" + 
			                                e.getMessage());
        }
        return SKIP_BODY;
    }
}
</pre></blockquote>    

<li>Primero tomamos el contenido del cuerpo y lo almacenamos en bc</li>
<li>Lo tratamos como cadena y lo guardamos en cuerpo</li>
<li>Obtenemos un canal de salida para escribir en el cliente con getEnclosingWriter().</li>
<li>Compilamos LogitudTag.<Li>
</ul>

<h2>Ejemplos.tld</h2>
<ul>
        <li>Incluir la nueva etiqueta en nuestra librería:</li>
<blockquote><pre>
&lt;tag&gt;
    &lt;name&gt;longitud&lt;/name&gt;
    &lt;tagclass&gt;LongitudTag&lt;/tagclass&gt;
    &lt;bodycontent&gt;JSP&lt;/bodycontent&gt;
    &lt;info&gt;calcula longitud de una cadena&lt;/info&gt;
&lt;/tag&gt;
</pre></blockquote>
<li>La etiqueta bodycontent le indica al motor de jsp cual va a ser el contenido del cuerpo.</li>
<li>Si el contenido es texto, html u otras etiquetas, se indica JSP, otro tipo de contenidos son tagdependent. Esto no afecta a la interpretación de la etiqueta, solamente es informativo.</li>
</ul>
<li>Longitud.jsp:</li>
<blockquote><pre>
&lt;%@ taglib uri="Ejemplos.tld" prefix="ejemplos" %&gt;
&lt;HTML&gt;
&lt;HEAD&gt;
    &lt;TITLE&gt;Tag Longitud&lt;/TITLE&gt;
&lt;/HEAD&gt;
&lt;ejemplos:longitud&gt;
Hola, soy una cadena
&lt;/ejemplos:longitud&gt;
&lt;/BODY&gt;
&lt;/HTML&gt;
</pre></blockquote>

<li>Hay un caso concreto de etiquetas con cuerpo, cuando se necesita que se evalúe el cuerpo mas de una vez. Esto se consigue devolviendo EVAL_BODY_TAG en lugar de SKIP_BODY en el método doAfterBody().</li>
</ul>

<h4>BucleTag.java</h4>
<p>Etiqueta personalizada que realice un bucle, que escriba un número determinado de veces el cuerpo de la etiqueta.</p>
<p>El codigo de la clase de la etiqueta bucle, es el siguiente:</p>
<blockquote><pre>
// BucleTag.java
import java.io.*;
import javax.servlet.jsp.*;
import javax.servlet.jsp.tagext.*;

public class BucleTag extends BodyTagSupport{
    int veces = 0;
    BodyContent bc;

    public void setVeces(int veces) {
        this.veces = veces;
    }
    public void setBodyContent(BodyContent bc){
        this.bc = bc;
    }
    public int doAfterBody() throws JspException {
        if (veces--&gt;0){
            try {
                JspWriter out = bc.getEnclosingWriter();
                out.println(bc.getString());
                bc.clearBody();
            } catch (IOException e) {
                system.out.println("Error en Tag Bucle" + 
				                        e.getMessage());
            }
            return EVAL_BODY_TAG;
        } else {
            return SKIP_BODY;
        }
    }
}
</pre></blockquote>


<h4>Ejemplos.tld</h4>
<p>Debemos añadir la descripción de esta nueva etiqueta a la librería:</p>
<blockquote><pre>
&lt;tag&gt;
    &lt;name&gt;bucle&lt;/name&gt;
    &lt;tagclass&gt;BucleTag&lt;/tagclass&gt;
    &lt;bodycontent&gt;JSP&lt;/bodycontent&gt;
    &lt;info&gt;realiza un bucle&lt;/info&gt;
    &lt;attribute&gt;
        &lt;name&gt;veces&lt;/name&gt;
        &lt;required&gt;true&lt;/required&gt;
        &lt;rtexprvalue&gt;true&lt;/rtexprvalue&gt;
        &lt;/attribute&gt;
&lt;/tag&gt;
</pre></blockquote>

<h4>Bucle.jsp</h4>
<blockquote><pre>
&lt;%@ taglib uri="Ejemplos.tld" prefix="ejemplos" %&gt;
&lt;HTML&gt;
&lt;HEAD&gt;
    &lt;TITLE&gt;Tag Bucle&lt;/TITLE&gt;
&lt;/HEAD&gt;
&lt;ejemplos:bucle veces="5"&gt;
Dentro del bucle&lt;br&gt;
&lt;/ejemplos:bucle&gt;
&lt;/BODY&gt;
&lt;/HTML&gt;
</pre></blockquote>


<h2>Conclusión</h2>
<ul>
        <li>Nos permite separar aún mas la lógica de presentación de la lógica de procesamiento.</li>
        <li>Personas con pocos conocimientos de programación utilicen características avanzadas (accesos a bases de datos, llamadas a procedimientos remotos, etc...).</li>
        <li>¡Reutilización del software!</li>
</ul>       


<ul>
		  <!--<li><a href="../jsp/tagsuma.jsp">Ejemplo tagsuma.jsp</a><a href="../jsp/html/tagsuma.jsp.html">( Ver código)</a></li>   -->     
</ul>

</body>
</html>
